# Changelog

## 2026-01-03
- Log LLM sort decisions (filename, target folder, reason) to `sort_decisions.log`.
- Add `run_metrics.log` with token/keep rates and invoice/receipt keyword counts per run.
- Add rename prompt guidance to avoid guessing document type and update examples away from invoice bias.
- Nudge keep-original prompting to prefer `keep` for concise stems and normalize only to shorten noise.
- Add a doc-type safeguard that forces `keep` when rename introduces invoice/receipt/order terms absent from metadata.
- Update module references to `rename_n_sort` across code, tests, CLI entrypoint, and docs.
- Rename plugin test files to the `test_plugin_<type>.py` convention.
- Split plugin coverage into individual `test_plugin_<type>.py` files for all plugins.
- Expand document and spreadsheet plugin tests to cover multiple sample types.
- Rename dependency check test to `test_all_required_deps.py` for earlier ordering.
- Add pytest `conftest.py` to ensure local package imports resolve without installation.
- Make Apple Foundation Models the primary macOS backend with Ollama fallback; remove DummyLLM fallback behavior.
- Process files one-by-one by default and simplify CLI flags accordingly.
- Rename console prefixes to `[SCAN]`, `[FILE]`, `[WHY]`, `[RENAME]`, and `[DEST]`, plus add per-file separators and shorter path display.
- Require Moondream2 captioning and OCR (pytesseract) for image metadata; include OCR text in summaries.
- Add `Brewfile`, clean and sort `pip_requirements.txt`, and add sample file generator + dependency availability tests.
- Remove `source_me_for_testing.sh`.
- Rename the distribution/CLI entrypoint to `llm-file-rename-n-sort`.
- Bundle Moondream2 captioning helpers directly in the repo to remove `OTHER_REPOS` dependencies.
- Rename `MacOSLocalLLM` to `AppleLLM`, rename the base class to `BaseClassLLM`, and add `--max-depth` (default 1).
- Add mutually-exclusive `--apply` and `--dry-run` flags (dry-run default) for safer CLI behavior.
- Default target root now uses `<search_root>/Organized` to keep files on the same drive unless `--target` is set.
- Clarify `--context` to indicate it is injected into LLM prompts with examples.
- Remove JSON/YAML config file support in favor of explicit CLI arguments.
- Switch XML parsing to a last-tag extraction strategy for chatty LLM outputs.
- Include caption + OCR context with guidance notes in rename prompts.
- Add EPUB support via OPF metadata parsing, plus a sample EPUB fixture and extraction test.
- Make test file extraction checks parameterized per extension and align prompt tests with tag-only instructions.
- Tighten sort prompts against JSON/code blocks, strip triple backticks from prompt text, and simplify sort descriptions to filetype + title.
- Simplify keep-original logging to store only parsed values plus raw response.
- Shift LLM prompts to example-driven flat tags, drop original-stem echoes, and simplify sort output to a single <category> tag.
- Update parsers to require unique tag names while ignoring extra chatter, and remove JSON fallbacks.
- Remove prompt-echo rejection so parsers only fail on missing or duplicate required tags.
- Replace keep_original with a 3-state stem_action (drop/normalize/keep) and allow legacy keep_original tags during transition.
- Allow rename responses without <reason> while still requiring <new_name>.
- Minimize LLM prompts to a single instruction plus context and an example output.
- Refine rename/keep prompts to emphasize human-readable filenames and reduce noisy tokens.
- For PDFs with two pages or fewer, render pages to images and use OCR+captioning instead of plain text extraction.
- Replace PDF rasterization via pyvips/libvips with pdf2image/poppler for more stable OCR rendering.
- Exclude `OTHER_REPOS` from pyflakes scanning to keep linting focused on this codebase.
- Remove the `cleaned/` path segment so targets are now `<target_root>/<category>/...`.
- Add OCR/rendering status and sample text logging for images and short PDFs.
- Avoid keeping numeric/generic original stems and normalize placeholder reasons.
- Let the LLM decide keep-original without extra heuristics; suppress placeholder keep reasons.
- Add a fallback LLM wrapper to use Ollama when Apple guardrails block content; skip files on LLM failures.
- Print PDF text samples under a [META] prefix and suppress duplicate desc output.
- Tighten keep-original prompts to reference the original stem explicitly and avoid metadata-based guesses.
- Rewrite keep-original prompt as a mechanical rule ladder with stem-quoted reasons.
- Refine keep-original ladder to favor real words and make machine-token tests explicit.
- Compute keep-original feature flags deterministically and pass them into the prompt for LLM decisions.
- Drop requirement that keep-original reasons quote the stem; require citing a feature flag.
- Remove pyvips/libvips as a required dependency for Moondream2 captioning.
- Improve ODT/ODP text extraction via odfpy teletype and add optional LibreOffice conversion for DOC/PPT when available.
- Drop textract as a required dependency; DOC/PPT extraction now relies on LibreOffice conversion when available.
- Skip files with unsupported extensions before LLM processing to avoid guardrail errors.
- Decouple keep-original decisions from content payloads and allow keep-original to run when rename hits guardrails.
- Add `docs/TODO.md` and `docs/ROADMAP.md` to track backlog items and planned work.
- Add LLM reliability tests for filename sanitization, placeholder reason normalization, and error surfacing.
- Add tiny image fixtures under `tests/test_files` plus a generator script and safer image extraction tests.
- Add clearer LibreOffice conversion diagnostics for DOC/PPT preview extraction.
- Add a sample OCR image and a basic OCR test for it.
- Update the test image generator to include a 128x32 SAMPLE OCR fixture.
- Add ZIP archive support with top-level entry summaries and a ZIP metadata test.
- Add per-plugin filetype hints to rename prompts and new filename normalization tests.
- Add context-window retry handling and relaxed keep-original parsing when the reason is malformed.
- Add file-only scanning guardrails and refine document filetype hints for plain text vs word processing.
- Add tests to ensure scanners and organizers skip directories and handle files only.
- Improve XML parsing by stripping code fences and tolerating malformed keep-original reasons.
- Log all XML parse failures to `XML_PARSE_FAILURES.log` for later review.
- Add malformed XML parser tests for code fences, chatter, and unclosed tags.
- Handle nested/escaped `<response>` blocks when Apple returns XML inside strings.
- Update keep-original prompt schema to discourage template echoing and nested responses.
- Fix folder-vs-file test to use the current organizer plan API and normalize escaped quotes in keep reasons.
- Log `keep_original` decisions to `KEEP_ORIGINAL_LOG.txt` for analysis.
- Log raw keep-original LLM responses to `KEEP_ORIGINAL.log` with file context.
- Include parsed keep-original values alongside raw responses in `KEEP_ORIGINAL.log`.
- Simplify keep-original parsing to use text between tags only.
- Accept rename/sort responses without a <response> wrapper when tags are present.
- Treat `<reason ...>` attributes as reason text when the reason body is missing.
- Update LLM prompts to request flat tags without XML wrappers or XML wording.
- Add tolerant parsing for prompt-echoed reasons and update keep-original logging with raw excerpts.
- Allow single-file sort parsing from JSON or a lone category line.
- Accept keep-original JSON responses when tags are missing.
- Write a RUN_START header at the top of keep-original and parse-failure logs.
- Clear KEEP_ORIGINAL.log and XML_PARSE_FAILURES.log at the start of each run.
- Add a dry-run summary of target directories and filenames after planning.
- Fall back to category "Other" if sorting fails during one-by-one processing.
- Remove "XML" wording from AppleLLM instructions; request tags only.
- Remove Apple-specific tag-return instruction to keep prompts backend-agnostic.
- Remove Apple-specific system instruction text to keep prompts fully shared.
- Rename Apple transport label to AppleLLM in LLM logging.
- Sanitize rename prompt content to strip non-printables, long tokens, and repeated lines.
- Retry Apple rename prompts with a minimal title+excerpt prompt on guardrail errors before falling back.
- Add ODG (OpenDocument Drawing) support in the vector image plugin.
- Add a PIL-based pyvips shim for Moondream2 to avoid libvips dependency.
- Add HTML/HTM support via BeautifulSoup for content extraction.
- Log Moondream2 caption start/finish with duration and truncate long caption output.
- Show an explicit note when keep_original is true without a justification.
- Print [LLM] notices for rename and keep-original prompts.
- Refactor LLM stack into shared prompts/parsers with transport-based backends and strict XML parsing.
- Add pytest coverage for content extraction on files in tests/test_files.
- Expand LLM engine/parser tests for fallback ordering and keep-original boolean variants.
- Tighten LLM engine error handling to distinguish transport failures from parse failures.
- Render up to two PDF pages for captioning even when PDFs are longer, and refine PDF/ocr sample labels.
- Add ODS preview extraction (sheet names + first rows) in the spreadsheet plugin.
- Include sheet names plus first row/column preview for ODS and XLSX metadata.
- Use openpyxl/xlrd for XLSX/XLS previews instead of XML parsing, and require those deps.
- Remove Python fallback keep_reason strings so LLM reasons are used as-is.
- Add repo-root SUPPORTED_EXTENSIONS.txt describing content-aware extraction per extension.
- Move detailed extension notes to docs/SUPPORTED_EXTENSIONS.md and make root list a simple extension list.
- Add content extraction for DOC/PPT via textract and PPTX/ODP via python-pptx/odfpy.
- Require python-pptx and textract (plus antiword/catdoc) for presentation/document content extraction.
- Remove unavailable Homebrew formula `catdoc`; rely on `antiword` for .doc support.
- Dump Apple guardrail prompts to GuardrailViolationError_XX.txt in the repo root.
- Show document summary text as [META] text sample instead of [WHY] desc.
- Add mutually exclusive randomize/sorted CLI ordering with randomize as the default.
- Adjust LLM prompts to request XML-only replies with minimal chatter.

## 2026-01-02
- Bump version to `26.01` and add root `VERSION` file synced with `pyproject.toml`.
- Lazy-import `ai_image_caption.moondream2` so optional caption dependencies load only when needed.
- Add `--one-by-one` mode to process each file through PLAN1/PLAN2 (and DRY RUN/APPLY) before starting the next file.
- Add `--llm-backend {macos,ollama}` to choose between the default macOS-local backend and Ollama.
- Print rename/keep/category decision details by default.
- Fix Ollama sorting-mode parsing to fill missing categories using the actual file indices in the batch (not `0..N-1`).
- Add tests for VERSION sync and keep-original heuristics, plus a CLI smoke script at `tests/run_smoke_cli.sh`.
- Fix pyflakes warnings (unused imports and duplicate dictionary keys).
- Update Ollama prompts/parsing to use an XML `<response>...</response>` block for robust extraction from chatty model outputs.
- Add repo-root runner script `run_file_cleanup.py`.
- Switch PDF parsing dependency from PyPDF2 to pypdf.
